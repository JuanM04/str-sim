%YAML 1.2
---
name: NetLogo
scope: source.netlogo
version: 2

variables:
  # NetLogo identifiers allow many special characters
  ident_char: "[\\w.?=*!<>:#+/%$_^'&-]"
  
  # NetLogo relies on whitespace or brackets to delimit words.
  # We replicate the TextMate lookbehind: (?<=^)|(?<=[\s\(\[])
  boundary_start: '(?:(?<=^)|(?<=[\s\(\[]))'
  # We replicate the TextMate lookahead: (?=$|[\s\)\]])
  boundary_end: '(?=$|[\s\)\]])'

contexts:
  main:
    - include: comments
    - include: strings
    - include: constants
    - include: functions
    - include: keywords
    - include: builtin-functions
    - include: operators
    - include: brackets
    - include: parens

  brackets:
    - match: \[
      scope: punctuation.section.brackets.begin.netlogo
      push:
        - meta_scope: meta.brackets.netlogo
        - match: \]
          scope: punctuation.section.brackets.end.netlogo
          pop: true
        - include: main

  parens:
    - match: \(
      scope: punctuation.section.parens.begin.netlogo
      push:
        - meta_scope: meta.parens.netlogo
        - match: \)
          scope: punctuation.section.parens.end.netlogo
          pop: true
        - include: main

  comments:
    - match: (;)
      scope: punctuation.definition.comment.netlogo
      push:
        - meta_scope: comment.line.semicolon.netlogo
        - match: $
          pop: true

  strings:
    - match: '"'
      scope: punctuation.definition.string.begin.netlogo
      push:
        - meta_scope: string.quoted.double.netlogo
        - match: '"'
          scope: punctuation.definition.string.end.netlogo
          pop: true
        - match: \\.
          scope: constant.character.escape.netlogo

  constants:
    - match: \b\d+\.\d+\b
      scope: constant.numeric.float.decimal.netlogo
    - match: \b\d+\b
      scope: constant.numeric.integer.netlogo
    - match: '{{boundary_start}}(false|true){{boundary_end}}'
      scope: constant.language.netlogo
    - match: '{{boundary_start}}(e|pi){{boundary_end}}'
      scope: constant.language.netlogo
    - match: '{{boundary_start}}(black|blue|brown|cyan|false|gray|grey|green|lime|magenta|orange|pink|red|sky|true|turquoise|violet|white|yellow){{boundary_end}}'
      scope: constant.language.color.netlogo

  functions:
    - match: ^\s*(to|to-report)\s+(\w+[-\w]*)
      captures:
        1: storage.type.class.netlogo
        2: entity.name.type.class.netlogo

  keywords:
    - match: '{{boundary_start}}(__includes|extensions){{boundary_end}}'
      scope: keyword.control.import.netlogo
    - match: '{{boundary_start}}(breed|globals|directed-link-breed|undirected-link-breed){{boundary_end}}'
      scope: storage.modifier.global.netlogo
    - match: '{{boundary_start}}(\w+\-own){{boundary_end}}'
      scope: storage.modifier.global.netlogo
    - match: '{{boundary_start}}(ifelse-value|ifelse|if){{boundary_end}}'
      scope: keyword.control.conditional.netlogo
    - match: '{{boundary_start}}foreach{{boundary_end}}'
      scope: keyword.control.loop.for.netlogo
    - match: '{{boundary_start}}(loop|while){{boundary_end}}'
      scope: keyword.control.loop.while.netlogo
    - match: '{{boundary_start}}(every|repeat){{boundary_end}}'
      scope: keyword.control.repeat.netlogo
    - match: '{{boundary_start}}(end){{boundary_end}}'
      scope: keyword.control.statement.netlogo
    # Complex generated regex for agents/breeds/sets
    - match: '{{boundary_start}}(?:(?:turtle(?:s)?(?:-own|-set|-here|-on|-at)?)|(?:patch(?:es)?(?:-own|-set|-here|-on|-at|-ahead|-at-heading-and-distance|-left-and-ahead|-right-and-ahead)?)|(?:link(?:s)?(?:-own|-set|-with|-neighbor\?|-neighbors|-at|-here|-on)?)|(?:create-(?:turtle(?:s)?|link(?:s)?|patch(?:es)?|\w+)(?:-to|-from|-with|-ordered)?)|(?:sprout(?:-\w+)?)|(?:hatch(?:-\w+)?)|(?:is-(?:turtle|patch|link|agent|agentset|patch-set|turtle-set|\w+)(?:\?)?)|(?:my(?:-links|-in-links|-out-links|-\w+|-in-\w+|-out-\w+)?)|(?:no-(?:turtles|patches|links))){{boundary_end}}'
      scope: keyword.other.netlogo
    # Extension identifier syntax (extension:primitive)
    - match: '{{boundary_start}}({{ident_char}}+):({{ident_char}}+){{boundary_end}}'
      captures:
        1: keyword.other.netlogo
        2: keyword.other.netlogo
    # Boolean/Set operators
    - match: '{{boundary_start}}(agentset|all|any|autoplot|autoplotx|autoploty|can-move|empty|hidden|hubnet-enter-message|hubnet-exit-message|hubnet-message-waiting|is-agent|is-agentset|is-anonymous-command|is-anonymous-reporter|is-list|is-number|is-patch|is-patch-set|is-string|is-turtle|is-turtle-set|member|mouse-down|mouse-inside|netlogo-web|plot-pen-exists|shade-of|user-yes-or-no)\?{{boundary_end}}'
      scope: keyword.other.netlogo
    # General Primitives (Long list from original source)
    - match: '{{boundary_start}}(abs|acos|approximate-hsb|approximate-rgb|ask|ask-concurrent|at-points|atan|auto-plot-off|auto-plot-on|auto-plot-x-off|auto-plot-x-on|auto-plot-y-off|auto-plot-y-on|back|bk|base-colors|behaviorspace-experiment-name|behaviorspace-run-number|both-ends|butfirst|but-first|but-last|carefully|ceiling|create-temporary-plot-pen|color|cos|count|cro|crt|current-plot|current-plot-pen|date-and-time|default-shape|die|diffuse|diffuse4|display|display-labels|distance|distancexy|downhill|downhill4|dx|dy|end1|end2|exp|export-all-plots|export-interface|export-output|export-plot|export-view|export-world|extract-hsb|extract-rgb|face|facexy|file-at-end?|file-close|file-close-all|file-delete|file-exists?|file-flush|file-open|file-print|file-read|file-read-characters|file-read-line|file-show|file-type|file-write|filter|first|floor|follow|follow-me|forward|fd|fput|hatch|heading|hide-link|hide-turtle|histogram|ht|home-directory|home|hsb|hubnet-broadcast|hubnet-broadcast-clear-output|hubnet-broadcast-message|hubnet-clear-override|hubnet-clear-overrides|hubnet-clients-list|hubnet-fetch-message|hubnet-kick-all-clients|hubnet-kick-client|hubnet-message|hubnet-message-source|hubnet-message-tag|hubnet-reset|hubnet-reset-perspective|hubnet-send|hubnet-send-clear-output|hubnet-send-follow|hubnet-send-message|hubnet-send-override|hubnet-send-watch|import-drawing|import-pcolors|import-pcolors-rgb|import-world|in-cone|in-radius|inspect|int|item|jump|label|label-color|last|layout-circle|layout-radial|layout-spring|layout-tutte|left|ln|lt|length|link-heading|link-length|link-neighbor?|link-neighbors|link-set|link-shapes|link-with|list|log|lput|map|max-n-of|max-one-of|max-pxcor|max-pycor|max|mean|median|min-n-of|min-one-of|min-pxcor|min-pycor|min|mod|modes|mouse-xcor|mouse-ycor|move-to|myself|n-of|n-values|netlogo-version|new-seed|neighbors|neighbors4|no-display|no-links|no-patches|no-turtles|nobody|one-of|other|other-end|output-print|output-show|output-type|output-write|patch|patch-set|patch-size|patches|pcolor|pen-down|pd|pen-erase|pe|pen-mode|pen-size|pen-up|pu|plabel-color|plabel|plot-name|plot-pen-down|plot-pen-reset|plot-pen-up|plot-x-max|plot-x-min|plot-y-max|plot-y-min|plot|plotxy|position|precision|print|pxcor|pycor|random-exponential|random-float|random-gamma|random-normal|random-poisson|random-pxcor|random-pycor|random-seed|random-xcor|random-ycor|random|read-from-string|reduce|remainder|remove|remove-duplicates|remove-item|replace-item|reverse|rgb|ride|ride-me|right|rt|round|scale-color|self|sentence|shape|shapes|show-link|show-turtle|st|shuffle|sin|size|sort|sort-by|sort-on|sprout|sqrt|stamp-erase|stamp|standard-deviation|sublist|subject|subtract-headings|sum|tan|thickness|ticks|tie|tie-mode|towards|towardsxy|turtle-set|turtle|turtles|untie|up-to-n-of|uphill|uphill4|update-plots|user-directory|user-file|user-input|user-message|user-new-file|user-one-of|variance|xcor|ycor|watch|watch-me|who|with-local-randomness|without-interruption|with-max|with-min|who-are-not|word|world-height|world-width|wrap-color){{boundary_end}}'
      scope: keyword.other.netlogo

  builtin-functions:
    - match: '{{boundary_start}}(__set-line-thickness|beep|clear-output|clear-all|ca|clear-all-plots|clear-drawing|cd|clear-globals|clear-links|clear-output|clear-patches|cp|clear-plot|clear-ticks|clear-turtles|ct|error|error-message|let|of|report|reset-perspective|rp|reset-ticks|resize-world|ride|ride-me|run|runresult|set-default-shape|set|set-current-plot|set-current-plot-pen|set-histogram-num-bars|set-patch-size|set-plot-background-color|set-plot-pen-color|set-plot-pen-interval|set-plot-pen-mode|set-plot-x-range|set-plot-y-range|show|setxy|setup-plots|startup|stop|stop-inspecting|stop-inspecting-dead-agents|tick|wait|with){{boundary_end}}'
      scope: support.function.builtin.netlogo

  operators:
    - match: \s(\+|-|\*|/|\^)\s
      captures:
        1: keyword.operator.arithmetic.netlogo
    - match: \-(?=[\d|e|pi])
      scope: keyword.operator.arithmetic.netlogo
    - match: \s(=|!=|>|>=|<|<=)\s
      captures:
        1: keyword.operator.comparison.netlogo
    - match: \s(and|or|xor)\s
      captures:
        1: keyword.operator.logical.netlogo
    - match: '{{boundary_start}}(not)\s'
      captures:
        1: keyword.operator.logical.netlogo
    - match: \s(->)\s
      captures:
        1: keyword.operator.assignment.netlogo